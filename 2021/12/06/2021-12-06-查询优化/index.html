<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>21/12/6 Database 查询优化 | Hexo</title><link rel="apple-touch-icon" sizes="57x57" href="/images/webclip/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/webclip/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/webclip/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/webclip/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/webclip/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/webclip/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/webclip/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/webclip/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/images/webclip/apple-touch-icon-167x167.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml"></head><body><main class="main"><header class="header"><div class="container"><nav class="navbar d-flex align-items-center"><a class="brand" href="/"><img class="logo lazyload" data-src="/images/brand.svg" alt="Hexo" role="img"></a><ul class="main-nav"><li class="nav-item"><a class="nav-item-link" href="/">首页</a></li><li class="nav-item"><a class="nav-item-link" href="/gallery">画廊</a></li><li class="nav-item"><a class="nav-item-link" href="/stories">案例</a></li><li class="nav-item"><a class="nav-item-link" href="/archives">新闻</a></li><li class="nav-item"><a class="nav-item-link" href="/about">关于</a></li></ul></nav><a id="mobile-nav-toggle"><span class="mobile-nav-toggle-bar"></span> <span class="mobile-nav-toggle-bar"></span> <span class="mobile-nav-toggle-bar"></span></a></div></header><section><div class="container"><article id="post-2021-12-06-查询优化" class="article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="artcle-cover mb-5"></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">21/12/6 Database 查询优化</h1><div class="article-meta"><time class="text-gray" datetime="2021-12-06T11:09:47.000Z" itemprop="datePublished">2021-12-06</time></div></header><div class="article-entry" itemprop="articleBody"><h1 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h1><h4 id="游标"><a href="#游标" class="headerlink" title="游标"></a>游标</h4><h6 id="目的-解决集合性操作语言与过程性操作语言的不匹配"><a href="#目的-解决集合性操作语言与过程性操作语言的不匹配" class="headerlink" title="目的-解决集合性操作语言与过程性操作语言的不匹配"></a>目的-解决集合性操作语言与过程性操作语言的不匹配</h6><h6 id="原因-sql一条语句一般能产生或处理多条记录-而主语言一次只能存放一条记录"><a href="#原因-sql一条语句一般能产生或处理多条记录-而主语言一次只能存放一条记录" class="headerlink" title="原因:sql一条语句一般能产生或处理多条记录,而主语言一次只能存放一条记录"></a>原因:sql一条语句一般能产生或处理多条记录,而主语言一次只能存放一条记录</h6><h6 id="是什么-是系统为用户开设的一个数据缓冲区-存放sql语句的执行结果"><a href="#是什么-是系统为用户开设的一个数据缓冲区-存放sql语句的执行结果" class="headerlink" title="是什么:是系统为用户开设的一个数据缓冲区,存放sql语句的执行结果"></a>是什么:是系统为用户开设的一个数据缓冲区,存放sql语句的执行结果</h6><p>用户可以用SQL语句逐一地从游标中获取记录,并赋给主变量</p><h6 id="定义游标-使用Declare语句"><a href="#定义游标-使用Declare语句" class="headerlink" title="定义游标: 使用Declare语句"></a>定义游标: 使用Declare语句</h6><p>EXEC SQL DECLARE &lt;&gt; CURSOR……</p><h6 id="打开游标–执行相应的select语句-吧所有满足查询条件的记录从指定表取到缓冲区中"><a href="#打开游标–执行相应的select语句-吧所有满足查询条件的记录从指定表取到缓冲区中" class="headerlink" title="打开游标–执行相应的select语句,吧所有满足查询条件的记录从指定表取到缓冲区中"></a>打开游标–执行相应的select语句,吧所有满足查询条件的记录从指定表取到缓冲区中</h6><p>EXEC SQL OPEN &lt;游标名&gt;</p><p>此时游标指针指向查询结果集中第一条记录之前</p><h6 id="推动游标"><a href="#推动游标" class="headerlink" title="推动游标"></a>推动游标</h6><p>使用FETCH语句</p><p>EXEC SQL FETCH [[NEXT]]….</p><p>指定方向推动游标指针,然后将缓冲区中的当前记录取出来送至主变量供主语言进一步处理</p><p>要求:主变量与select语句中的目标列表达式具有一一对应关系</p><h6 id="关闭游标"><a href="#关闭游标" class="headerlink" title="关闭游标"></a>关闭游标</h6><p>CLOSE语句</p><p>EXEC SQL CLOSE &lt;游标名&gt;</p><h2 id="7-1查询处理过程"><a href="#7-1查询处理过程" class="headerlink" title="7.1查询处理过程"></a>7.1查询处理过程</h2><h3 id="7-1-1-查询分析"><a href="#7-1-1-查询分析" class="headerlink" title="7.1.1 查询分析"></a>7.1.1 查询分析</h3><p>对查询语句进行扫描,词法分析和语法分析</p><h3 id="7-1-2查询检查"><a href="#7-1-2查询检查" class="headerlink" title="7.1.2查询检查"></a>7.1.2查询检查</h3><p>根据数据字典中的用户权限和完整性约束定义对用户的存取权限进行检查</p><p>检查通过后将SQL查询语句转换成等价的<code>&lt;u&gt;</code>关系代数表达式<code>&lt;/u&gt;</code></p><h3 id="7-1-4查询优化"><a href="#7-1-4查询优化" class="headerlink" title="7.1.4查询优化"></a>7.1.4查询优化</h3><p>选择一个高效执行的查询处理策略</p><h4 id="代数优化-关系代数表达式优化"><a href="#代数优化-关系代数表达式优化" class="headerlink" title="代数优化-关系代数表达式优化"></a>代数优化-关系代数表达式优化</h4><h4 id="物理优化-存取物理介质及…的优化"><a href="#物理优化-存取物理介质及…的优化" class="headerlink" title="物理优化-存取物理介质及…的优化"></a>物理优化-存取物理介质及…的优化</h4><h3 id="7-1-5查询执行"><a href="#7-1-5查询执行" class="headerlink" title="7.1.5查询执行"></a>7.1.5查询执行</h3><p>不用多言</p><h2 id="7-2执行查询操作的基本算法"><a href="#7-2执行查询操作的基本算法" class="headerlink" title="7.2执行查询操作的基本算法"></a>7.2执行查询操作的基本算法</h2><h3 id="1-选择操作"><a href="#1-选择操作" class="headerlink" title="1. 选择操作"></a>1. 选择操作</h3><p>顺序扫描&#x2F;二分查找&#x2F;索引[散列]&#x2F;复合选择</p><p>索引–提供元组指针,间接检索</p><p>B+树索引:同样是提供元组指针,同时支持顺序集中依次查找</p><p>如是 sdept&#x3D;’cs’ and sae&gt;20:则</p><p>算法一:分别查询,求交集</p><p>算法而:先找到第一个查询的指针,然后在第一个查询的指针基础上进行第二个查询</p><h3 id="2-连接操作"><a href="#2-连接操作" class="headerlink" title="2.连接操作"></a>2.连接操作</h3><h6 id="连接操作是查询处理中最耗时的操作之一"><a href="#连接操作是查询处理中最耗时的操作之一" class="headerlink" title="连接操作是查询处理中最耗时的操作之一"></a>连接操作是查询处理中最耗时的操作之一</h6><p>[例2]</p><p>SELECT *</p><p>FROM Student,SC</p><p>WHERE Student.Sno&#x3D;SC.Sno</p><p>[例2end]</p><ol><li>嵌套循环法<br>对外层循环的每一个元组,检测内层循环中的每一个元组,检查两个元组在连接属性上是否相等<br>满足,即串接后作为结果输出</li><li>索引链接法<br>在输出表上建立属性Sno的索引(如果原来没有)<br>对student中每个元组,有Sno值通过Sc……..</li><li>排序合并法<br>适合连接的诸表已经排好序的情况<br>没排序则排序<br>取Student表中第一个sno,然后依次找sc表中具有相同sno的元组<br>扫到sno不相同的第一个sc元组时,返回Student扫描它的下一个元组<br>之后循环</li><li>散列连接法<br>把连接属性作为散列码,<br>然后划分</li></ol><h3 id="3-投影操作"><a href="#3-投影操作" class="headerlink" title="3.投影操作"></a>3.投影操作</h3><h6 id="选取关系的某些列-从垂直的方向减小关系的大小"><a href="#选取关系的某些列-从垂直的方向减小关系的大小" class="headerlink" title="选取关系的某些列,从垂直的方向减小关系的大小"></a>选取关系的某些列,从垂直的方向减小关系的大小</h6><p>如果投影属性列包括了关系R的主键,则操作可言直接执行,操作结果将于R中元组个数相同</p><p>否则则需要消除重复元组</p><h3 id="4-集合运算操作"><a href="#4-集合运算操作" class="headerlink" title="4.集合运算操作"></a>4.集合运算操作</h3><p>并,查,交,笛卡尔积</p><p>并查缴类似排序合并法</p><p>笛卡尔积一般嵌套循环合并</p><h2 id="7-3关系数据库系统的查询优化"><a href="#7-3关系数据库系统的查询优化" class="headerlink" title="7.3关系数据库系统的查询优化"></a>7.3关系数据库系统的查询优化</h2><p>分布式数据库:总代接&#x3D;I&#x2F;O代价+*****</p><h4 id="7-3-2查询优化实例"><a href="#7-3-2查询优化实例" class="headerlink" title="7.3.2查询优化实例"></a>7.3.2查询优化实例</h4><p>假定学生-课程数据库中有1000个学生记录,10000个选课记录</p><p>其中选修二号课程的选课记录为50个</p><p>查询选修了2号课程的学生姓名</p><h5 id="第一种情况"><a href="#第一种情况" class="headerlink" title="第一种情况"></a>第一种情况</h5><h6 id="1-计算广义笛卡尔积"><a href="#1-计算广义笛卡尔积" class="headerlink" title="1.计算广义笛卡尔积"></a>1.计算广义笛卡尔积</h6><p>-把student和sc的每个元组连接起来的做法</p><h6 id="2-做选择操作"><a href="#2-做选择操作" class="headerlink" title="2.做选择操作"></a>2.做选择操作</h6><p>依次读入连接后的元组,按照选择条件选取满足要求的记录</p><h6 id="3-做投影操作"><a href="#3-做投影操作" class="headerlink" title="3.做投影操作"></a>3.做投影操作</h6><p>把第二步操作的结果在Sname上作投影输出,得到最终输出</p><h5 id="第二种情况"><a href="#第二种情况" class="headerlink" title="第二种情况"></a>第二种情况</h5><h6 id="1-计算自然连接"><a href="#1-计算自然连接" class="headerlink" title="1.计算自然连接"></a>1.计算自然连接</h6><h6 id="2-读取中间文件块-进行选择操作"><a href="#2-读取中间文件块-进行选择操作" class="headerlink" title="2.读取中间文件块,进行选择操作"></a>2.读取中间文件块,进行选择操作</h6><h6 id="3-投影输出"><a href="#3-投影输出" class="headerlink" title="3.投影输出"></a>3.投影输出</h6><h5 id="第三种情况"><a href="#第三种情况" class="headerlink" title="第三种情况"></a>第三种情况</h5><h6 id="1-先对sc表进行选择运算"><a href="#1-先对sc表进行选择运算" class="headerlink" title="1.先对sc表进行选择运算"></a>1.先对sc表进行选择运算</h6><h6 id="2-读取Student表-把读入的student元组和内存中收到sc元组做连接"><a href="#2-读取Student表-把读入的student元组和内存中收到sc元组做连接" class="headerlink" title="2.读取Student表,把读入的student元组和内存中收到sc元组做连接"></a>2.读取Student表,把读入的student元组和内存中收到sc元组做连接</h6><h6 id="3-把连接结果投影输出"><a href="#3-把连接结果投影输出" class="headerlink" title="3.把连接结果投影输出"></a>3.把连接结果投影输出</h6><p>假如SC表的Cno字段&#x2F;Student表上的Sno有索引,可加快读取</p><h4 id="有选择和连接操作时-先做选择操作–代数优化"><a href="#有选择和连接操作时-先做选择操作–代数优化" class="headerlink" title="有选择和连接操作时,先做选择操作–代数优化"></a>有选择和连接操作时,先做选择操作–代数优化</h4><h4 id="选择操作算法有权标扫描和索引扫描两种-在第三种情况下-索引扫描效果好–物理优化"><a href="#选择操作算法有权标扫描和索引扫描两种-在第三种情况下-索引扫描效果好–物理优化" class="headerlink" title="选择操作算法有权标扫描和索引扫描两种,在第三种情况下,索引扫描效果好–物理优化"></a>选择操作算法有权标扫描和索引扫描两种,在第三种情况下,索引扫描效果好–物理优化</h4><h3 id="7-3-3-代数优化"><a href="#7-3-3-代数优化" class="headerlink" title="7.3.3 代数优化"></a>7.3.3 代数优化</h3><h4 id="关系代数表达式的等价变换规则"><a href="#关系代数表达式的等价变换规则" class="headerlink" title="关系代数表达式的等价变换规则"></a>关系代数表达式的等价变换规则</h4><p>指用相同的关系代替两个表达式中相应的关系所得到的结果是相同的</p><h5 id="常用的等价变换规则"><a href="#常用的等价变换规则" class="headerlink" title="常用的等价变换规则"></a>常用的等价变换规则</h5><h4 id="代数优化策略-通过对关系代数表达式的等价变化来提高查询效率"><a href="#代数优化策略-通过对关系代数表达式的等价变化来提高查询效率" class="headerlink" title="代数优化策略-通过对关系代数表达式的等价变化来提高查询效率"></a>代数优化策略-通过对关系代数表达式的等价变化来提高查询效率</h4><h5 id="启发式规则"><a href="#启发式规则" class="headerlink" title="启发式规则"></a>启发式规则</h5><ol><li><strong>选择运算尽可能先做,最重要最基本的一条</strong></li><li>把投影运算和选择运算同时进行</li><li>把投影同其前后的双目运算结合起来</li><li>把某些选择同在它前面要执行的笛卡尔积结合起来形成一个连接运算’</li><li>找出公共子表达式</li></ol><h4 id="代数优化算法"><a href="#代数优化算法" class="headerlink" title="代数优化算法"></a>代数优化算法</h4><p>输入:一个查询树</p><p>输出:优化的查询树</p><h5 id="物理优化"><a href="#物理优化" class="headerlink" title="物理优化"></a>物理优化</h5><p>代数优化改变查询语句中操作的次序和组合,不涉及底层的存取路径</p><p>定义:选择高效合理的操作算法&#x2F;存取路径</p><h6 id="基于存取路径的优化"><a href="#基于存取路径的优化" class="headerlink" title="基于存取路径的优化"></a>基于存取路径的优化</h6><p>选择操作的启发式规则–</p><ol><li><p>对于小关系,使用全表顺序扫描,即使有索引</p></li><li><p>对于大关系–</p><ol><li>对于选择条件是主键&#x3D;值的查询<br>选择主键索引</li><li>对于选择条件是非主属性&#x3D;值的查询,且选择列上有索引<br>估算查询结果的元组书目–比例小(10%),索引,比例大-全表</li><li>选择条件是属性上的非等值查询或范围查询,且存在索引<br>估算查询结果的元组书目–比例小(10%),索引,比例大-全表</li><li>对于用and连接的合取选择条件<br>优先采用组合索引扫描….</li><li>or连接<br>一般全表</li></ol></li></ol><p>连接操作的启发式规则</p><ol><li>两个比哦啊都已经按照连接属性排序<br>排序合并法</li><li>一个表在连接属性上有索引<br>索引连接法</li><li>都不是1,2,而其中一个表比较小<br>散列连接法</li><li>可以选用嵌套循环阀,并选择较小的表作为外表</li></ol><h6 id="基于代价估算的优化"><a href="#基于代价估算的优化" class="headerlink" title="基于代价估算的优化"></a>基于代价估算的优化</h6><h6 id="二者结合的优化"><a href="#二者结合的优化" class="headerlink" title="二者结合的优化"></a>二者结合的优化</h6></div><footer class="article-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/class3/" rel="tag">class3</a></li></ul></footer></div><nav class="article-nav pt-4 mt-3" id="article-nav"><a href="/2021/12/06/2021-12-06-database-Complication/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">数据库完整性概述</div></a><a href="/2021/12/06/21-12-6-Database-exp-8/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">21/12/6 Database exp 8</div></a></nav></article></div></section><footer class="footer pt-5 mt-5"><div class="container"><div class="py-3"><div class="row justify-content-between"><div class="col-6"><img class="filter-gray mb-3 lazyload" height="40" data-src="/images/brand.svg" alt="Hexo" role="img"><p class="mb-4"></p><ul class="list-inline"></ul></div><div class="col-4"><h5>友情链接</h5><ul class="list-inline"></ul></div></div></div><hr class="hr" style="opacity:.25"><div class="pt-3 pb-5"><ul class="list-inline mb-0 text-center"><li class="list-inline-item">&copy; 2023 Hexo</li><li class="list-inline-item">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li><li class="list-inline-item">Designer <a href="https://acorn.imaging.xin/" target="_blank">YSH</a></li></ul></div></div></footer></main><div id="mobile-nav-dimmer"></div><div id="mobile-nav"><div id="mobile-nav-inner"><ul class="mobile-nav"><li class="nav-item"><a class="nav-item-link" href="/">首页</a></li><li class="nav-item"><a class="nav-item-link" href="/gallery">画廊</a></li><li class="nav-item"><a class="nav-item-link" href="/stories">案例</a></li><li class="nav-item"><a class="nav-item-link" href="/archives">新闻</a></li><li class="nav-item"><a class="nav-item-link" href="/about">关于</a></li></ul></div></div><script src="/libs/feather/feather.min.js"></script><script src="/libs/lazysizes/lazysizes.min.js"></script><script src="/libs/tocbot/tocbot.min.js"></script><script>tocbot.init({tocSelector:".js-toc",contentSelector:".js-toc-content",headingSelector:"h2, h3",hasInnerContainers:!0})</script><script src="/js/mobile-nav.js"></script><script src="/js/script.js"></script></body></html>