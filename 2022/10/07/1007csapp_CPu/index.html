<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CSAPP Machine Level Programming | Hexo</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config={root:"/",path:"search.json"}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:!0,theme:"dark"})</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face{font-family:BenderLight;src:local('Bender'),url(/font/BenderLight.ttf)}@font-face{font-family:'JetBrains Mono';src:local('JetBrains Mono'),url(/font/JetBrainsMono-Regular.woff2) format('woff2')}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg)"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>CSAPP Machine Level Programming</h1><div id="post-info"><span>First Post:<div class="control"><time datetime="2022-10-07T00:43:00.000Z" id="date">2022-10-07</time></div></span><br><span>Last Update:<div class="control"><time datetime="2022-10-13T04:41:31.632Z" id="updated">2022-10-13</time></div></span><br><span>Word Count:<div class="control">766</div></span><br><span>Read Time:<div class="control">2 min</div></span></div></div><hr><div id="post-content"><h2 id="C-语言-基础属性"><a href="#C-语言-基础属性" class="headerlink" title="C 语言 基础属性"></a>C 语言 基础属性</h2><p>数组的指针运算– 数组存储的是它的指针,其指针++ 会跳过存储数据量的位置(如 int a[10],a++ ,arr[a]会+4)</p><h2 id="struct的对齐"><a href="#struct的对齐" class="headerlink" title="struct的对齐"></a>struct的对齐</h2><p>由于会根据struct中的最大的基本结构类型[int,double,float 之类的,和列表没关系]来进行对齐[例如,struct中存在double就会按照8byte对齐,如果最大只有int,就按照4byte对齐],因此,最好将结构合理组织,</p><p>如</p><blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S4</span>&#123;</span><span class="comment">//char :1 byte, int : 4byte</span></span><br><span class="line">    <span class="type">char</span> c;<span class="comment">// 产生3个用于对齐的内存浪费</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> d;<span class="comment">// 产生3个用于对齐的浪费</span></span><br><span class="line">&#125;<span class="comment">// waste 3+3 byte</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S5</span>&#123;</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">char</span> d;<span class="comment">//c,d一并存储,产生2个用于对齐的浪费</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h2 id="Memory-Layout"><a href="#Memory-Layout" class="headerlink" title="Memory Layout"></a>Memory Layout</h2><h3 id="IMG"><a href="#IMG" class="headerlink" title="IMG:"></a>IMG:</h3><img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221007163747876.png" alt="image-20221007163747876" style="zoom:33%"><h2 id="Buffer-OverFlow"><a href="#Buffer-OverFlow" class="headerlink" title="Buffer OverFlow"></a>Buffer OverFlow</h2><img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221007163839893.png" alt="image-20221007163839893" style="zoom:33%"><blockquote><ul><li>注: 内存是按照0x7FFFFFFFFFFF 也就是2^47来作为地址的,所以各位置之间可能会有较大的差距[因为暂时,硬件条件并不会使得整块可供分配的内存id映射被用尽]</li></ul><p>stack:</p><ul><li>8MB</li><li>向下拓展[地址高标号低]</li></ul><p>Data:</p><ul><li>用于存放程序开始时分配的数据<ul><li>存放全局变量</li></ul></li></ul><p>Heap:</p><ul><li>存放通过malloc&#x2F;相关函数申请的变量,会动态变化</li><li>大的数据块会出现在靠近stack的位置,并向下增长,小的数据块会出现在靠近Data的位置,并向上增长</li></ul><p>SharedLibraries:</p><ul><li>存放库函数代码[一般在磁盘上]</li><li>在运行时动态加载到内存中</li></ul></blockquote><h2 id="Unions"><a href="#Unions" class="headerlink" title="Unions"></a>Unions</h2><h2 id="BufferOverFlow"><a href="#BufferOverFlow" class="headerlink" title="BufferOverFlow"></a>BufferOverFlow</h2><h3 id="代码注入攻击详解"><a href="#代码注入攻击详解" class="headerlink" title="代码注入攻击详解"></a>代码注入攻击详解</h3><blockquote><p>举例: gets 会不断读取字符串,直至收到一个’\0’</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">echo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">4</span>];<span class="comment">/* Way too small*/</span></span><br><span class="line">    gets(buf);</span><br><span class="line">    <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时,若输入大于4个字符,echo还是可以接收</p><p>查看汇编代码可以看到,调用echo的时候给stackFrame分配了24byte的空间</p><p>如果输入大于23个字符,就会报出 segment fault</p><ul><li>这时候该函数的返回位置可能被溢出的字符串覆盖,使得函数不会到main这个接口,而是进入一个新的地区</li><li>这就是代码注入攻击</li></ul><p>小于23就没事,</p></blockquote><h3 id="How-to-Avoid"><a href="#How-to-Avoid" class="headerlink" title="How to Avoid"></a>How to Avoid</h3><blockquote><ol><li>使用安全的替代<ol><li>fgets-&gt; gets</li><li>strncopy-&gt; strcopy</li><li>scanf(“%ns”)-&gt; scanf(“%s”)</li></ol></li><li>Randomized stack offsets– 地址空间布局随机化<ol><li>使得每次程序运行的时候,它分配到的缓冲区长度都是变化的</li></ol></li><li>None executable code segments<ol><li>在可读&#x2F;可写等内存标识之外增加一个 “execute” 权限</li></ol></li><li>stack canary 栈保护机制<ol><li><img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221007201652095.png" alt="image-20221007201652095"></li><li>程序会检测到栈溢出的问题并返回</li></ol></li></ol></blockquote><h3 id="A-Skill-to-Avoid-Randomized-stack-offset-x2F-None-executable-code-segments"><a href="#A-Skill-to-Avoid-Randomized-stack-offset-x2F-None-executable-code-segments" class="headerlink" title="A Skill to Avoid Randomized stack offset&#x2F;None executable code segments"></a>A Skill to Avoid Randomized stack offset&#x2F;None executable code segments</h3><blockquote><ul><li>但是躲不开canary</li></ul><h4 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h4><p>A Example:<img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221008122557042.png" alt="image-20221008122557042" style="zoom:50%"></p><p>p后面的值恰好和mov rax rdi 相等,结尾又是一个c3,因此这一段额外的代码会在p赋值之后执行,并返回.</p><p>这样就实现了在代码中插入一定量的自己的小代码,返回后就可以通过获取rsp栈中的代码,来将之前的代码块拼接一起执行.</p></blockquote><h3 id="GDB-Trick"><a href="#GDB-Trick" class="headerlink" title="GDB Trick"></a>GDB Trick</h3><blockquote><p>disass [FUNC_NAME]</p><p>解析对应函数的汇编代码</p></blockquote><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right:calc(50% - 1px);order:1;border-right:1px solid #fe2;padding-left:unset;max-width:calc(50% - 4px)"><a href="/2022/10/08/1008CSAPP%20Optimize/">← Next CSAPP Optimize 笔记</a></div><div id="footer-link" style="left:50%;order:0;border-left:1px solid #fe2;padding-right:unset;max-width:calc(50% - 5px)"><a href="/2022/10/02/1002%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-Towards%20a%20Fully%20Disaggregated%20and%20Programmable/">论文阅读笔记-Towards a Fully Disaggregated and Programmable Data Center Prev →</a></div></div></div><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onclick="scrolls.scrolltop()" title="to top" style="opacity:0;display:none">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Yue-plus">YSH</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#C-%E8%AF%AD%E8%A8%80-%E5%9F%BA%E7%A1%80%E5%B1%9E%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">C 语言 基础属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#struct%E7%9A%84%E5%AF%B9%E9%BD%90"><span class="toc-number">2.</span> <span class="toc-text">struct的对齐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory-Layout"><span class="toc-number">3.</span> <span class="toc-text">Memory Layout</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IMG"><span class="toc-number">3.1.</span> <span class="toc-text">IMG:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer-OverFlow"><span class="toc-number">4.</span> <span class="toc-text">Buffer OverFlow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unions"><span class="toc-number">5.</span> <span class="toc-text">Unions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BufferOverFlow"><span class="toc-number">6.</span> <span class="toc-text">BufferOverFlow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB%E8%AF%A6%E8%A7%A3"><span class="toc-number">6.1.</span> <span class="toc-text">代码注入攻击详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-Avoid"><span class="toc-number">6.2.</span> <span class="toc-text">How to Avoid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#A-Skill-to-Avoid-Randomized-stack-offset-x2F-None-executable-code-segments"><span class="toc-number">6.3.</span> <span class="toc-text">A Skill to Avoid Randomized stack offset&#x2F;None executable code segments</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Gadget"><span class="toc-number">6.3.1.</span> <span class="toc-text">Gadget</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GDB-Trick"><span class="toc-number">6.4.</span> <span class="toc-text">GDB Trick</span></a></li></ol></li></ol></div></div></div><footer><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr>Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=e=>{new Valine({el:"#Valine",appId:"MkE8c5Abvy4XAwiLVVgu2cbC-gzGzoHsz",appKey:"IYs46cd4ti4DN1JUw7aNIRVj",placeholder:"此条评论委托企鹅物流发送"}),code.findCode(),mermaid.init(void 0,".mermaid")}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>