<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>CSAPP Machine Level Programming | Hexo</title><link rel="apple-touch-icon" sizes="57x57" href="/images/webclip/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/webclip/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/webclip/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/webclip/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/webclip/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/webclip/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/webclip/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/webclip/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/images/webclip/apple-touch-icon-167x167.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml"></head><body><main class="main"><header class="header"><div class="container"><nav class="navbar d-flex align-items-center"><a class="brand" href="/"><img class="logo lazyload" data-src="/images/brand.svg" alt="Hexo" role="img"></a><ul class="main-nav"><li class="nav-item"><a class="nav-item-link" href="/">首页</a></li><li class="nav-item"><a class="nav-item-link" href="/gallery">画廊</a></li><li class="nav-item"><a class="nav-item-link" href="/stories">案例</a></li><li class="nav-item"><a class="nav-item-link" href="/archives">新闻</a></li><li class="nav-item"><a class="nav-item-link" href="/about">关于</a></li></ul></nav><a id="mobile-nav-toggle"><span class="mobile-nav-toggle-bar"></span> <span class="mobile-nav-toggle-bar"></span> <span class="mobile-nav-toggle-bar"></span></a></div></header><section><div class="container"><article id="post-1007csapp_CPu" class="article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="artcle-cover mb-5"></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">CSAPP Machine Level Programming</h1><div class="article-meta"><time class="text-gray" datetime="2022-10-07T00:43:00.000Z" itemprop="datePublished">2022-10-07</time><div class="article-category"><a class="article-category-link" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></div></div></header><div class="article-entry" itemprop="articleBody"><h2 id="C-语言-基础属性"><a href="#C-语言-基础属性" class="headerlink" title="C 语言 基础属性"></a>C 语言 基础属性</h2><p>数组的指针运算– 数组存储的是它的指针,其指针++ 会跳过存储数据量的位置(如 int a[10],a++ ,arr[a]会+4)</p><h2 id="struct的对齐"><a href="#struct的对齐" class="headerlink" title="struct的对齐"></a>struct的对齐</h2><p>由于会根据struct中的最大的基本结构类型[int,double,float 之类的,和列表没关系]来进行对齐[例如,struct中存在double就会按照8byte对齐,如果最大只有int,就按照4byte对齐],因此,最好将结构合理组织,</p><p>如</p><blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S4</span>&#123;</span><span class="comment">//char :1 byte, int : 4byte</span></span><br><span class="line">    <span class="type">char</span> c;<span class="comment">// 产生3个用于对齐的内存浪费</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> d;<span class="comment">// 产生3个用于对齐的浪费</span></span><br><span class="line">&#125;<span class="comment">// waste 3+3 byte</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S5</span>&#123;</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">char</span> d;<span class="comment">//c,d一并存储,产生2个用于对齐的浪费</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h2 id="Memory-Layout"><a href="#Memory-Layout" class="headerlink" title="Memory Layout"></a>Memory Layout</h2><h3 id="IMG"><a href="#IMG" class="headerlink" title="IMG:"></a>IMG:</h3><img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221007163747876.png" alt="image-20221007163747876" style="zoom:33%"><h2 id="Buffer-OverFlow"><a href="#Buffer-OverFlow" class="headerlink" title="Buffer OverFlow"></a>Buffer OverFlow</h2><img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221007163839893.png" alt="image-20221007163839893" style="zoom:33%"><blockquote><ul><li>注: 内存是按照0x7FFFFFFFFFFF 也就是2^47来作为地址的,所以各位置之间可能会有较大的差距[因为暂时,硬件条件并不会使得整块可供分配的内存id映射被用尽]</li></ul><p>stack:</p><ul><li>8MB</li><li>向下拓展[地址高标号低]</li></ul><p>Data:</p><ul><li>用于存放程序开始时分配的数据<ul><li>存放全局变量</li></ul></li></ul><p>Heap:</p><ul><li>存放通过malloc&#x2F;相关函数申请的变量,会动态变化</li><li>大的数据块会出现在靠近stack的位置,并向下增长,小的数据块会出现在靠近Data的位置,并向上增长</li></ul><p>SharedLibraries:</p><ul><li>存放库函数代码[一般在磁盘上]</li><li>在运行时动态加载到内存中</li></ul></blockquote><h2 id="Unions"><a href="#Unions" class="headerlink" title="Unions"></a>Unions</h2><h2 id="BufferOverFlow"><a href="#BufferOverFlow" class="headerlink" title="BufferOverFlow"></a>BufferOverFlow</h2><h3 id="代码注入攻击详解"><a href="#代码注入攻击详解" class="headerlink" title="代码注入攻击详解"></a>代码注入攻击详解</h3><blockquote><p>举例: gets 会不断读取字符串,直至收到一个’\0’</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">echo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">4</span>];<span class="comment">/* Way too small*/</span></span><br><span class="line">    gets(buf);</span><br><span class="line">    <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时,若输入大于4个字符,echo还是可以接收</p><p>查看汇编代码可以看到,调用echo的时候给stackFrame分配了24byte的空间</p><p>如果输入大于23个字符,就会报出 segment fault</p><ul><li>这时候该函数的返回位置可能被溢出的字符串覆盖,使得函数不会到main这个接口,而是进入一个新的地区</li><li>这就是代码注入攻击</li></ul><p>小于23就没事,</p></blockquote><h3 id="How-to-Avoid"><a href="#How-to-Avoid" class="headerlink" title="How to Avoid"></a>How to Avoid</h3><blockquote><ol><li>使用安全的替代<ol><li>fgets-&gt; gets</li><li>strncopy-&gt; strcopy</li><li>scanf(“%ns”)-&gt; scanf(“%s”)</li></ol></li><li>Randomized stack offsets– 地址空间布局随机化<ol><li>使得每次程序运行的时候,它分配到的缓冲区长度都是变化的</li></ol></li><li>None executable code segments<ol><li>在可读&#x2F;可写等内存标识之外增加一个 “execute” 权限</li></ol></li><li>stack canary 栈保护机制<ol><li><img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221007201652095.png" alt="image-20221007201652095"></li><li>程序会检测到栈溢出的问题并返回</li></ol></li></ol></blockquote><h3 id="A-Skill-to-Avoid-Randomized-stack-offset-x2F-None-executable-code-segments"><a href="#A-Skill-to-Avoid-Randomized-stack-offset-x2F-None-executable-code-segments" class="headerlink" title="A Skill to Avoid Randomized stack offset&#x2F;None executable code segments"></a>A Skill to Avoid Randomized stack offset&#x2F;None executable code segments</h3><blockquote><ul><li>但是躲不开canary</li></ul><h4 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h4><p>A Example:<img src="C:\Users\Ysh78\AppData\Roaming\Typora\typora-user-images\image-20221008122557042.png" alt="image-20221008122557042" style="zoom:50%"></p><p>p后面的值恰好和mov rax rdi 相等,结尾又是一个c3,因此这一段额外的代码会在p赋值之后执行,并返回.</p><p>这样就实现了在代码中插入一定量的自己的小代码,返回后就可以通过获取rsp栈中的代码,来将之前的代码块拼接一起执行.</p></blockquote><h3 id="GDB-Trick"><a href="#GDB-Trick" class="headerlink" title="GDB Trick"></a>GDB Trick</h3><blockquote><p>disass [FUNC_NAME]</p><p>解析对应函数的汇编代码</p></blockquote></div><footer class="article-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csapp/" rel="tag">csapp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul></footer></div><nav class="article-nav pt-4 mt-3" id="article-nav"><a href="/2022/10/08/1008CSAPP%20Optimize/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">CSAPP Optimize 笔记</div></a><a href="/2022/10/02/1002%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-Towards%20a%20Fully%20Disaggregated%20and%20Programmable/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">论文阅读笔记-Towards a Fully Disaggregated and Programmable Data Center</div></a></nav></article></div></section><footer class="footer pt-5 mt-5"><div class="container"><div class="py-3"><div class="row justify-content-between"><div class="col-6"><img class="filter-gray mb-3 lazyload" height="40" data-src="/images/brand.svg" alt="Hexo" role="img"><p class="mb-4"></p><ul class="list-inline"></ul></div><div class="col-4"><h5>友情链接</h5><ul class="list-inline"></ul></div></div></div><hr class="hr" style="opacity:.25"><div class="pt-3 pb-5"><ul class="list-inline mb-0 text-center"><li class="list-inline-item">&copy; 2023 Hexo</li><li class="list-inline-item">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li><li class="list-inline-item">Designer <a href="https://acorn.imaging.xin/" target="_blank">YSH</a></li></ul></div></div></footer></main><div id="mobile-nav-dimmer"></div><div id="mobile-nav"><div id="mobile-nav-inner"><ul class="mobile-nav"><li class="nav-item"><a class="nav-item-link" href="/">首页</a></li><li class="nav-item"><a class="nav-item-link" href="/gallery">画廊</a></li><li class="nav-item"><a class="nav-item-link" href="/stories">案例</a></li><li class="nav-item"><a class="nav-item-link" href="/archives">新闻</a></li><li class="nav-item"><a class="nav-item-link" href="/about">关于</a></li></ul></div></div><script src="/libs/feather/feather.min.js"></script><script src="/libs/lazysizes/lazysizes.min.js"></script><script src="/libs/tocbot/tocbot.min.js"></script><script>tocbot.init({tocSelector:".js-toc",contentSelector:".js-toc-content",headingSelector:"h2, h3",hasInnerContainers:!0})</script><script src="/js/mobile-nav.js"></script><script src="/js/script.js"></script></body></html>